<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMK Pricing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-label { @apply block text-sm font-medium text-slate-700 mb-1; }
        .input-field { @apply mt-1 block w-full py-2 px-3 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 sm:text-sm; }
        .checkbox-label { @apply ml-2 text-sm text-slate-700; }
        .radio-label { @apply ml-2 text-sm text-slate-700; }
        
        .btn { @apply w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2; }

        .summary-item { @apply flex justify-between py-1; }
        .summary-label { @apply text-slate-600; }
        .summary-value { @apply font-semibold text-slate-800; }
        .quote-item-card { @apply mb-3 p-4 border border-slate-200 rounded-lg bg-white shadow-md; } 
        .quote-item-header { @apply flex justify-between items-start; }
        .quote-item-description { @apply text-sm text-slate-700 flex-grow; }
        .quote-item-price { @apply text-sm font-semibold text-sky-700 ml-2; }
        .quote-item-actions { @apply flex items-center flex-shrink-0; } 
        select { max-width: 100%; }

        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #pricingSummarySection { margin: 0; padding: 20px; border: none; box-shadow: none; width: 100%; max-width: 100%; background-color: #fff !important; }
            #appContainer.max-w-4xl.mx-auto.bg-white { box-shadow: none !important; padding: 0 !important; }
            body.bg-slate-100 { background-color: #fff !important; } 
            .quote-item-card { page-break-inside: avoid; border: 1px solid #ccc; background-color: #f9f9f9 !important; }
            .accordion-header, .accordion-content { background-color: #fff !important; border: 1px solid #eee !important; }
            .print-header-bg { background-color: #2596be !important; color: white !important; } 
            .print-header-bg p { color: #e2e8f0 !important; } 

            body.print-no-pricing-mode .item-line-price,
            body.print-no-pricing-mode .option-cost-detail,
            body.print-no-pricing-mode #quoteTotalsBreakdown > div:not(:last-of-type) {
                display: none !important;
            }
            body.print-no-pricing-mode .quote-item-price {
                 display: none !important;
            }
        }
        
        .accordion-header {
            @apply flex justify-between items-center w-full px-4 py-3 text-left text-md font-medium text-slate-800 bg-slate-100 hover:bg-slate-200 rounded-t-lg focus:outline-none focus-visible:ring focus-visible:ring-orange-500 focus-visible:ring-opacity-75 cursor-pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .accordion-header.open { @apply rounded-b-none bg-slate-200; }
        .accordion-header .icon {
            transition: transform 0.2s ease-in-out; @apply text-slate-500;
        }
        .accordion-header.open .icon {
            transform: rotate(90deg);
        }
        .accordion-content {
            @apply px-4 text-sm text-slate-700 bg-white border border-t-0 border-slate-200 rounded-b-lg;
            max-height: 0;
            overflow: hidden;
            padding-top: 0; 
            padding-bottom: 0; 
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
        }
        .accordion-content.open {
            @apply pt-4 pb-4; 
            max-height: 1000px; 
        }
        
    </style>

</head>
<body class="bg-slate-100 p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl" id="appContainer">
            <header class="mb-8 text-center no-print py-6 [background-color:#2596be] rounded-lg print-header-bg relative" id="appHeader">
                <img src="../assets/logo-rmk.png" alt="RMK Logo" class="mx-auto h-16 mb-4" onerror="this.src='https.placehold.co/200x60/2596be/FFFFFF?text=RMK+Logo&font=montserrat'; this.onerror=null;">
                <h1 class="text-2xl font-bold text-white">RMK Windows &amp; Doors Pricing</h1>
                <p class="text-sm text-sky-100">2025 Pricing Guidelines - Internal Use</p>

                <a href="#" class="absolute bottom-2 right-4 text-white text-xs underline hover:text-orange-300" onclick="alert('Login redirect disabled for preview.'); return false;">
                    Return to Login
                </a>

                <a href="../assets/current-pricing-042125.pdf" target="_blank" rel="noopener noreferrer" class="absolute bottom-2 left-4 text-white text-xs underline hover:text-orange-300">
                Current Pricing
                </a>
            </header>

        <form id="pricingForm" class="space-y-6 no-print">
            <div>
                <label for="productType" class="input-label">1. Select Product Type to Configure:</label>
                <select id="productType" class="input-field">
                    <option value="">-- Select --</option>
                    <option value="window">Window</option>
                    <option value="door">Door</option>
                </select>
            </div>

            <div id="windowOptionsSection" class="hidden space-y-6 p-4 border border-slate-200 rounded-lg bg-white">
                <h2 class="text-xl font-semibold text-sky-700 border-b border-slate-200 pb-2">Configure Window</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label for="windowManufacturer" class="input-label">Window Manufacturer (Vinyl):</label>
                        <select id="windowManufacturer" class="input-field"></select>
                    </div>
                    <div>
                        <label for="windowQuantity" class="input-label">Quantity:</label>
                        <input type="number" id="windowQuantity" class="input-field" value="1" min="1" max="10">
                    </div>
                </div>
                <div>
                    <label for="windowSeries" class="input-label">Window Series:</label>
                    <select id="windowSeries" class="input-field"></select>
                </div>
                <div id="anlinFrameTypeSection" class="hidden">
                    <label for="anlinFrameType" class="input-label">Frame Type:</label>
                    <select id="anlinFrameType" class="input-field"></select>
                </div>
                 <div id="anlinColorSection" class="hidden">
                    <label for="anlinColor" class="input-label">Color:</label>
                    <select id="anlinColor" class="input-field"></select>
                </div>
                <div id="windowTypeSection" class="hidden">
                    <label for="windowType" class="input-label">Window Type:</label>
                    <select id="windowType" class="input-field"></select>
                </div>
                <div>
                    <label class="input-label">Sizing Method:</label>
                    <div class="mt-2 space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="windowSizeMode" value="ui" class="form-radio text-orange-500 focus:ring-orange-500" checked="">
                            <span class="radio-label">United Inches (UI)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="windowSizeMode" value="wh" class="form-radio text-orange-500 focus:ring-orange-500">
                            <span class="radio-label">Width &amp; Height</span>
                        </label>
                    </div>
                </div>
                <div id="windowUISizeSection">
                    <label for="windowUI" class="input-label">United Inches (UI):</label>
                    <input type="number" id="windowUI" class="input-field" placeholder="e.g., 70">
                </div>
                <div id="windowWHSizeSection" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label for="windowWidth" class="input-label">Width (inches):</label>
                        <input type="number" id="windowWidth" class="input-field" placeholder="e.g., 36">
                    </div>
                    <div>
                        <label for="windowHeight" class="input-label">Height (inches):</label>
                        <input type="number" id="windowHeight" class="input-field" placeholder="e.g., 48">
                    </div>
                </div>
                <div id="calculatedUIDisplay" class="text-sm text-slate-600 mt-1 hidden">Calculated UI: <span id="calculatedUIValue" class="font-semibold">0</span></div>
                
                <fieldset class="pt-2">
                    <legend class="input-label mb-1">Window Adders:</legend>
                    <div class="space-y-2">
                        <div><input type="checkbox" id="windowGrids" class="rounded text-orange-500 focus:ring-orange-500"><label for="windowGrids" class="checkbox-label">Grids</label></div>
                        <div><input type="checkbox" id="windowTempered" class="rounded text-orange-500 focus:ring-orange-500"><label for="windowTempered" class="checkbox-label">Tempered Glass</label></div>
                        <div><input type="checkbox" id="windowObscure" class="rounded text-orange-500 focus:ring-orange-500"><label for="windowObscure" class="checkbox-label">Obscure Glass</label></div>
                        <div id="sashDeadBoltSection" class="hidden"><input type="checkbox" id="sashDeadBolt" class="rounded text-orange-500 focus:ring-orange-500"><label for="sashDeadBolt" class="checkbox-label">Sash Dead-Bolt ($18)</label></div>
                    </div>
                </fieldset>
                 <div id="windowSpecialNotes" class="mt-2 text-sm text-red-600 bg-red-50 p-3 rounded-md hidden"></div>
            </div>

            <div id="doorOptionsSection" class="hidden space-y-6 p-4 border border-slate-200 rounded-lg bg-white">
                <h2 class="text-xl font-semibold text-sky-700 border-b border-slate-200 pb-2">Configure Door</h2>
                <div>
                    <label for="doorManufacturer" class="input-label">Door Manufacturer (Vinyl):</label>
                    <select id="doorManufacturer" class="input-field"></select>
                </div>
                 <div>
                    <label for="doorSeries" class="input-label">Door Series:</label>
                    <select id="doorSeries" class="input-field"></select>
                </div>
                <div>
                    <label for="doorHeightType" class="input-label">Door Height Type:</label>
                    <select id="doorHeightType" class="input-field">
                        <option value="">-- Select Height --</option>
                        <option value="6/08 TALL DOORS">6/08 Tall (6'8")</option>
                        <option value="8/00 TALL DOORS">8/00 Tall (8'0")</option>
                    </select>
                </div>
                <div>
                    <label for="doorSize" class="input-label">Door Size:</label>
                    <select id="doorSize" class="input-field"></select>
                </div>
                <fieldset class="pt-2">
                    <legend class="input-label mb-1">Door Adders:</legend>
                    <div class="space-y-2">
                        <div><input type="checkbox" id="doorGrids" class="rounded text-orange-500 focus:ring-orange-500"><label for="doorGrids" class="checkbox-label">Grids</label></div>
                    </div>
                </fieldset>
            </div>
            
            <div id="itemSpecificAddOnsSection" class="space-y-3 p-4 border border-slate-200 rounded-lg no-print bg-white hidden">
                <!-- Content populated by JS -->
            </div>

            <div id="globalQuoteAddOnsSection" class="space-y-2 p-4 border border-slate-200 rounded-lg no-print bg-white mt-6">
                <!-- Accordions for global add-ons will be populated here by JS -->
            </div>
            
            <div class="p-4 border border-dashed border-sky-300 rounded-lg bg-sky-50 space-y-3 no-print" id="currentItemPricingBlock">
                <h3 class="text-lg font-semibold text-sky-700">4. Calculate & Add Item to Quote</h3>
                <div id="currentItemPriceDisplay" class="text-xl font-bold text-sky-600">$0.00</div>
                <div id="currentItemDescriptionDisplay" class="text-sm text-slate-600">Configure an item above and calculate its price.</div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" id="calculateCurrentItemBtn" class="flex-1 w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Calculate Current Item Price</button>
                    <button type="button" id="addItemToQuoteBtn" class="flex-1 w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">Add Current Item to Quote</button>
                </div>
            </div>

        </form> 
        
        <div id="pricingSummarySection" class="mt-10 p-6 bg-white rounded-lg shadow-xl"> 
            <div class="print-only hidden my-4 p-4 border-b border-black print-header-bg">
                <img src="../assets/logo-rmk.png" alt="RMK Windows &amp; Doors Logo" class="mx-auto mb-3 h-10" onerror="this.src='https.placehold.co/200x60/2596be/FFFFFF?text=RMK+Logo&font=montserrat'; this.onerror=null;">
                <h2 class="text-2xl font-bold text-white">RMK Windows &amp; Doors</h2>
                <p class="text-sky-100">1015 North McQeen Road #168 Gilbert, Arizona 85233</p>
                <p class="text-sky-100">Phone: 480-240-4669 | Email: orders@rmkwindows.com</p>
                <p class="text-sky-100">Date: <span id="printDate"></span></p>
            </div>
            <h2 class="text-2xl font-semibold text-sky-700 mb-4 border-b border-slate-200 pb-2">Full Quote Summary</h2>
            <div id="quoteItemsListDisplay" class="mb-4 space-y-2">
                 <p class="text-sm text-slate-500" id="emptyQuoteMsg">No items added to the quote yet.</p>
            </div>
            <div id="quoteTotalsBreakdown" class="space-y-1 mb-4 pt-4 border-t border-slate-200"></div>
            <div class="summary-item border-t-2 border-sky-600 pt-3 mt-3">
                <span class="text-xl font-bold text-sky-700">Grand Total:</span>
                <span id="grandTotalPrice" class="text-xl font-bold text-sky-700">$0.00</span>
            </div>
            <div id="manualQuoteItemsSection" class="mt-4 hidden">
                <h3 class="text-lg font-semibold text-orange-600">Items Requiring Manual Quote:</h3>
                <ul id="manualQuoteItemsList" class="list-disc list-inside text-orange-500 text-sm"></ul>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-3 no-print p-4 bg-orange-50 rounded-lg border border-orange-300" id="quoteActionButtons">
                <button type="button" id="printQuoteBtn" class="flex-1 w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Print Quote (Save as PDF)</button>
                <button type="button" id="printQuoteNoPricingBtn" class="flex-1 w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-slate-700 bg-slate-200 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Print Quote (Total Only)</button>
                <button type="button" id="clearQuoteBtn" class="flex-1 w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-red-500 text-base font-medium rounded-md shadow-sm text-red-600 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Clear Entire Quote</button>
            </div>
        </div>
    </div>

<script>
let isSettingUpEdit = false;

document.addEventListener('DOMContentLoaded', function() {
    try {
        appContainer = document.getElementById('appContainer');
        appHeader = document.getElementById('appHeader'); 
        productTypeSelect = document.getElementById('productType');
        windowOptionsSection = document.getElementById('windowOptionsSection');
        windowManufacturerSelect = document.getElementById('windowManufacturer');
        windowQuantityInput = document.getElementById('windowQuantity'); 
        windowSeriesSelect = document.getElementById('windowSeries');
        anlinFrameTypeSection = document.getElementById('anlinFrameTypeSection');
        anlinFrameTypeSelect = document.getElementById('anlinFrameType');
        anlinColorSection = document.getElementById('anlinColorSection');
        anlinColorSelect = document.getElementById('anlinColor');
        windowTypeSection = document.getElementById('windowTypeSection'); 
        windowTypeSelect = document.getElementById('windowType'); 
        windowUISizeSection = document.getElementById('windowUISizeSection');
        windowWHSizeSection = document.getElementById('windowWHSizeSection');
        windowUIInput = document.getElementById('windowUI');
        windowWidthInput = document.getElementById('windowWidth');
        windowHeightInput = document.getElementById('windowHeight');
        calculatedUIDisplay = document.getElementById('calculatedUIDisplay');
        calculatedUIValue = document.getElementById('calculatedUIValue');
        windowGridsCheckbox = document.getElementById('windowGrids');
        windowTemperedCheckbox = document.getElementById('windowTempered');
        windowObscureCheckbox = document.getElementById('windowObscure');
        sashDeadBoltSection = document.getElementById('sashDeadBoltSection');
        sashDeadBoltCheckbox = document.getElementById('sashDeadBolt');
        windowSpecialNotesDiv = document.getElementById('windowSpecialNotes');
        windowSizeRadioButtons = document.querySelectorAll('input[name="windowSizeMode"]');
        doorOptionsSection = document.getElementById('doorOptionsSection');
        doorManufacturerSelect = document.getElementById('doorManufacturer');
        doorSeriesSelect = document.getElementById('doorSeries');
        doorHeightTypeSelect = document.getElementById('doorHeightType');
        doorSizeSelect = document.getElementById('doorSize');
        doorGridsCheckbox = document.getElementById('doorGrids');
        itemSpecificAddOnsSection = document.getElementById('itemSpecificAddOnsSection'); 
        globalQuoteAddOnsSection = document.getElementById('globalQuoteAddOnsSection'); 
        calculateCurrentItemBtn = document.getElementById('calculateCurrentItemBtn');
        addItemToQuoteBtn = document.getElementById('addItemToQuoteBtn');
        clearQuoteBtn = document.getElementById('clearQuoteBtn');
        printQuoteBtn = document.getElementById('printQuoteBtn');
        printQuoteNoPricingBtn = document.getElementById('printQuoteNoPricingBtn'); 
        pricingSummarySection = document.getElementById('pricingSummarySection'); 
        quoteItemsListDisplay = document.getElementById('quoteItemsListDisplay');
        emptyQuoteMsg = document.getElementById('emptyQuoteMsg'); 
        quoteTotalsBreakdown = document.getElementById('quoteTotalsBreakdown');
        grandTotalPriceSpan = document.getElementById('grandTotalPrice');
        manualQuoteItemsSection = document.getElementById('manualQuoteItemsSection');
        manualQuoteItemsList = document.getElementById('manualQuoteItemsList');
        printDateSpan = document.getElementById('printDate');
        currentItemPriceDisplay = document.getElementById('currentItemPriceDisplay');
        currentItemDescriptionDisplay = document.getElementById('currentItemDescriptionDisplay');
        currentItemPricingBlock = document.getElementById('currentItemPricingBlock');
        quoteActionButtons = document.getElementById('quoteActionButtons');

        if (productTypeSelect) productTypeSelect.addEventListener('change', handleProductTypeChange);
        if (windowManufacturerSelect) windowManufacturerSelect.addEventListener('change', populateWindowSeries);
        if (windowSeriesSelect) windowSeriesSelect.addEventListener('change', updateWindowOptionsForSeries);
        if (windowTypeSelect) windowTypeSelect.addEventListener('change', handleWindowTypeChange);
        if (windowSizeRadioButtons) windowSizeRadioButtons.forEach(radio => radio.addEventListener('change', handleWindowSizeModeChange));
        if(windowWidthInput) windowWidthInput.addEventListener('input', updateCalculatedUI);
        if(windowHeightInput) windowHeightInput.addEventListener('input', updateCalculatedUI);
        if(windowUIInput) windowUIInput.addEventListener('input', handleWindowUIInputChange);
        if (doorManufacturerSelect) doorManufacturerSelect.addEventListener('change', populateDoorSeries);
        if (doorSeriesSelect) {
            doorSeriesSelect.addEventListener('change', () => {
                if (doorHeightTypeSelect) doorHeightTypeSelect.value = ""; 
                if (doorSizeSelect) doorSizeSelect.innerHTML = '<option value="">-- Select Size --</option>';
            });
        }
        if (doorHeightTypeSelect) doorHeightTypeSelect.addEventListener('change', populateDoorSizes);
        if (calculateCurrentItemBtn) calculateCurrentItemBtn.addEventListener('click', calculateAndShowSummary);
        if (addItemToQuoteBtn) addItemToQuoteBtn.addEventListener('click', addItemOrUpdateQuote);
        if (clearQuoteBtn) clearQuoteBtn.addEventListener('click', clearQuote);
        if (printQuoteBtn) printQuoteBtn.addEventListener('click', handlePrintQuote);
        if (printQuoteNoPricingBtn) printQuoteNoPricingBtn.addEventListener('click', handlePrintQuoteNoPricing);

        populateItemSpecificAddOns();
        populateGlobalAddOns();
        resetCurrentItemDisplay();
        updateFullQuoteSummaryDisplay(); 

    } catch (error) {
        console.error("Initialization Error (DOMContentLoaded):", error);
        showToast("Error initializing the application. Please refresh.", "error");
    }
});

const pricingData = {
    windows: { 
        manufacturers: {
            "ANLIN": { 
                 series: { "CATALINA": { 
                     pricingModel: "new",
                     windowTypes: ["X Single Hung", "XO/OX Single Glider", "XOX 3-Lite Glider", "PW - Fixed"],
                     colors: { "White": 1.0, "Tan": 1.15, "Adobe": 1.15, "Black/Black": 1.92 },
                     pricingTable: {
                        "X Single Hung": {
                            "Block or Nail Fin": {"0-72": 510, "73-84": 551, "85-96": 594, "97-108": 604, "109-120": 639, "121-132": 668, "133-144": 720, "145-156": 788, "157-168": 874},
                            "Stucco Flange":   {"0-72": 538, "73-84": 648, "85-96": 713, "97-108": 748, "109-120": 810, "121-132": 874, "133-144": 955, "145-156": 1058, "157-168": 1169}
                        },
                        "XO/OX Single Glider": {
                            "Block or Nail Fin": {"0-72": 466, "73-84": 525, "85-96": 561, "97-108": 615, "109-120": 680, "121-132": 715, "133-144": 734, "145-156": 805, "157-168": 880},
                            "Stucco Flange":   {"0-72": 550, "73-84": 622, "85-96": 680, "97-108": 759, "109-120": 851, "121-132": 921, "133-144": 969, "145-156": 1075, "157-168": 1175}
                        },
                        "XOX 3-Lite Glider": {
                            "Block or Nail Fin": {"0-72": 545, "73-84": 583, "85-96": 626, "97-108": 717, "109-120": 907, "121-132": 976, "133-144": 1079, "145-156": 1197, "157-168": 1293, "169-180": 1351, "181-192": 1414, "193-216": 1516},
                            "Stucco Flange":   {"0-72": 629, "73-84": 680, "85-96": 745, "97-108": 861, "109-120": 1078, "121-132": 1182, "133-144": 1314, "145-156": 1467, "157-168": 1588, "169-180": 1672, "181-192": 1758, "193-216": 1912}
                        },
                        "PW - Fixed": {
                            "Block or Nail Fin": {"0-72": 363, "73-84": 408, "85-96": 445, "97-108": 499, "109-120": 551, "121-132": 628, "133-144": 689, "145-156": 753, "157-168": 836, "169-180": 920},
                            "Stucco Flange":   {"0-72": 447, "73-84": 505, "85-96": 564, "97-108": 643, "109-120": 722, "121-132": 834, "133-144": 924, "145-156": 1023, "157-168": 1131, "169-180": 1241}
                        }
                     },
                     adders: { "Sash Dead-Bolt": 18 },
                     addersUiFactor: { "GRIDS": 1.00, "TEMPERED": 4.00, "OBSCURE": 2.50 }, 
                     specialNotes: null
                    }
                }
            },
            "MILGARD": {
                series: { "TRINSIC (V300)": { pricingModel: "old", windowTypes: ["PIC/1LS (XO)/SH", "3LS (XOX)", "CSMT/AWNING", "SPCL SHAPE/ARCH"], basePrice: { upTo65UI: 675, upTo130UI: 1100 }, uiFactorOver130: { "PIC/1LS (XO)/SH": 10.00, "3LS (XOX)": 10.50, "CSMT/AWNING": 12.00, "SPCL SHAPE/ARCH": 12.50 }, addersUiFactor: { "GRIDS": 1.00, "TEMPERED": 3.50, "OBSCURE": 4.00 }, specialNotes: null, colors: {"Black/Black": 1.52} } }
            },
            "IWC": {
                series: {
                    "CROWN": { pricingModel: "old", windowTypes: ["PIC/1LS (XO)/SH", "3LS (XOX)", "CSMT/AWNING", "SPCL SHAPE/ARCH"], basePrice: { upTo65UI: 625, upTo130UI: 800 }, uiFactorOver130: { "PIC/1LS (XO)/SH": 6.50, "3LS (XOX)": 8.00, "CSMT/AWNING": 6.50, "SPCL SHAPE/ARCH": 15.00 }, addersUiFactor: { "GRIDS": 1.00, "TEMPERED": 3.50, "OBSCURE": 1.00 }, specialNotes: "CASEMENTS ONLY AVAILABLE AS NAIL FIN OR BLOCK FRAME.", hasBlackOnBlack: true, colors: {"Black/Black": 1.0} },
                    "Ambassador": { pricingModel: "old", windowTypes: ["PIC/1LS (XO)/SH", "3LS (XOX)", "CSMT/AWNING", "SPCL SHAPE/ARCH"], basePrice: { upTo65UI: 1150, upTo130UI: 1400 }, uiFactorOver130: { "PIC/1LS (XO)/SH": 11.00, "3LS (XOX)": 13.00, "CSMT/AWNING": 21.00, "SPCL SHAPE/ARCH": 21.00 }, addersUiFactor: { "GRIDS": 1.00, "TEMPERED": 4.00, "OBSCURE": 1.00 }, specialNotes: "CASEMENTS ONLY AVAILABLE AS NAIL FIN OR BLOCK FRAME.", hasBlackOnBlack: true, colors: {"Black/Black": 1.0} }
                }
            }
        },
        anlinFrameTypes: ["Block or Nail Fin", "Stucco Flange"]
    },
    doors: { 
        manufacturers: {
            "ANLIN": { series: { "MALIBU": { prices: { "6/08 TALL DOORS": { "5'-0\"x6'8\"": 2692, "6'-0\"x6'8\"": 2860, "6'-6\"x6'8\"": 2860, "8'-0\"x6'8\"": 3203, "9'-0\"x6'8\"": 4228, "12'-0\"x6'8\"": 5570 }, "8/00 TALL DOORS": { "5'-0\"x8'0\"": 2985, "6'-0\"x8'0\"": 3286, "6'-6\"x8'0\"": 3286, "8'-0\"x8'0\"": 4010, "9'-0\"x8'0\"": 4750, "12'-0\"x8'0\"": 6550 } }, adders: { "GRIDS_UI_FACTOR": 1.00 } } } },
            "MILGARD": { series: { "V400": { prices: { "6/08 TALL DOORS": { "5'-0\"x6'8\"": 2918, "6'-0\"x6'8\"": 3092, "6'-6\"x6'8\"": 3405, "8'-0\"x6'8\"": 3672, "9'-0\"x6'8\"": 5727, "12'-0\"x6'8\"": 6965 }, "8/00 TALL DOORS": { "5'-0\"x8'0\"": 3507, "6'-0\"x8'0\"": 3692, "6'-6\"x8'0\"": 4076, "8'-0\"x8'0\"": 4392, "9'-0\"x8'0\"": 6328, "12'-0\"x8'0\"": 7979 } }, adders: { "GRIDS_UI_FACTOR": 1.00 } } } },
            "IWC": { series: { "5800": { prices: { "6/08 TALL DOORS": { "5'-0\"x6'8\"": 2724, "6'-0\"x6'8\"": 2899, "6'-6\"x6'8\"": 3012, "8'-0\"x6'8\"": 3293, "9'-0\"x6'8\"": null, "12'-0\"x6'8\"": 5346 }, "8/00 TALL DOORS": { "5'-0\"x8'0\"": 3062, "6'-0\"x8'0\"": 3268, "6'-6\"x6'8\"": 3403, "8'-0\"x8'0\"": 4104, "9'-0\"x8'0\"": null, "12'-0\"x8'0\"": 5961 } }, adders: { "GRIDS_UI_FACTOR": 1.00 } } } }
        }
    },
    addOns: { 
        "EXTERIOR TRIM": { category: "General Site & Finish", per: "OPENING", price: 150, type: "fixed", scope: "item", itemCategory: "Most Used" },
        "INTERIOR JAMB & CASING": { category: "General Site & Finish", per: "OPENING", price: 200, type: "fixed", scope: "item", itemCategory: "Most Used" },
        "STUCCO REPAIR": { category: "General Site & Finish", per: "OPENING", price: 450, type: "fixed", scope: "item", itemCategory: "Most Used" },
        "R&R SECURITY BARS (WINDOWS)": { category: "General Site & Finish", per: "OPENING", price: 35, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "2ND FLOOR SET UP": { category: "General Site & Finish", per: "SIDE", price: 300, type: "fixed", scope: "global" },
        "COIL WRAP": { category: "Permits & Special Orders", per: "OPENING", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "PERMITING- GENERAL": { category: "Permits & Special Orders", per: "ADDRESS", price: 500, type: "fixed", scope: "global" },
        "PERMITING ENGINEERED DRAWINGS": { category: "Permits & Special Orders", per: "OCCURANCE", price: 4500, type: "fixed", scope: "global" },
        "REMOVE STL CSMT (INCL DRYWALL/STUCCO REPAIR)": { category: "Modifications & Structural", per: "OPENING", price: 150, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "CUT OUT VINYL WINDOWS": { category: "Modifications & Structural", per: "OPENING", price: 150, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "CUT OUT & FRAME IN WINDOW": { category: "Modifications & Structural", per: "OPENING", price: 1900, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "FILL IN EXISTING WINDOW": { category: "Modifications & Structural", per: "OPENING", price: 1300, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "CUT DOWN WINDOW FOR DOOR (WOOD FRAMING)": { category: "Modifications & Structural", per: "OPENING", price: 1300, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "CUT DOWN WINDOW FOR DOOR (BLOCK WALL)": { category: "Modifications & Structural", per: "OPENING", price: 1900, type: "fixed", scope: "item", itemCategory: "Less Common" },
        "INSTALL HEADER UP TO 96\"": { category: "Modifications & Structural", per: "UP TO 96\"", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "INSTALL HEADER UP TO 216\"": { category: "Modifications & Structural", per: "UP TO 216\"", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "INSTALL HEADER OVER 216\"": { category: "Modifications & Structural", per: "OVER 216\"", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "POCKET HEADER": { category: "Modifications & Structural", per: "N/A", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "RAISE HEADER": { category: "Modifications & Structural", per: "OCCURANCE", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "ENCLOSE PATIO": { category: "Modifications & Structural", per: "OCCURANCE", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "CLOSE IN SINGLE DOOR": { category: "Modifications & Structural", per: "OPENING", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "CLOSE IN DOUBLE DOOR OPENING": { category: "Modifications & Structural", per: "OPENING", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "PET DOOR IN SLIDING DOOR": { category: "Modifications & Structural", per: "OCCURANCE", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" },
        "PET DOOR IN WALL": { category: "Modifications & Structural", per: "OCCURANCE", price: 0, type: "quote", scope: "item", itemCategory: "Needs Quote (External)" }
    }
};

let quoteItems = []; 
let editingItemIndex = null; 

let productTypeSelect, windowOptionsSection, windowManufacturerSelect, windowSeriesSelect,
    anlinFrameTypeSection, anlinFrameTypeSelect, anlinColorSection, anlinColorSelect,
    windowTypeSection, windowTypeSelect,
    windowUIInput, windowWidthInput, windowHeightInput, calculatedUIDisplay, calculatedUIValue,
    windowGridsCheckbox, windowQuantityInput,
    windowTemperedCheckbox, windowObscureCheckbox, sashDeadBoltSection, sashDeadBoltCheckbox,
    windowSpecialNotesDiv, doorOptionsSection,
    doorManufacturerSelect, doorSeriesSelect, doorHeightTypeSelect, doorSizeSelect,
    doorGridsCheckbox, 
    itemSpecificAddOnsSection, globalQuoteAddOnsSection, 
    calculateCurrentItemBtn, addItemToQuoteBtn, clearQuoteBtn, printQuoteBtn, printQuoteNoPricingBtn,
    pricingSummarySection, quoteItemsListDisplay, emptyQuoteMsg, quoteTotalsBreakdown, grandTotalPriceSpan,
    manualQuoteItemsSection, manualQuoteItemsList, appHeader,
    currentItemPriceDisplay, currentItemDescriptionDisplay, currentItemPricingBlock,
    windowUISizeSection, windowWHSizeSection, windowSizeRadioButtons, appContainer, printDateSpan,
    quoteActionButtons;

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.className = 'fixed bottom-4 right-4 z-50 px-6 py-3 rounded-md shadow-lg text-white text-sm transition-all duration-300 ease-in-out transform translate-y-20 opacity-0';
    if (type === 'success') { toast.classList.add('bg-green-600'); } 
    else if (type === 'error') { toast.classList.add('bg-red-600'); } 
    else { toast.classList.add('bg-sky-600'); }
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.remove('translate-y-20', 'opacity-0');
        toast.classList.add('translate-y-0', 'opacity-100');
    }, 20); 
    setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 2800); 
    setTimeout(() => { if (toast.parentNode) { toast.parentNode.removeChild(toast); } }, 3300); 
}

function populateItemSpecificAddOns() {
    if (!itemSpecificAddOnsSection) return;
    itemSpecificAddOnsSection.innerHTML = ''; 
    const mainTitle = document.createElement('h2');
    mainTitle.className = "text-xl font-semibold text-sky-700 border-b border-slate-200 pb-2 mb-3";
    mainTitle.textContent = "2. Additional Options for This Item";
    itemSpecificAddOnsSection.appendChild(mainTitle);
    const categories = { "Most Used": [], "Less Common": [], "Needs Quote (External)": [] };
    Object.keys(pricingData.addOns).forEach(addOnKey => {
        const addOn = pricingData.addOns[addOnKey];
        if (addOn.scope === "item" && addOn.itemCategory && categories[addOn.itemCategory]) {
            categories[addOn.itemCategory].push({ key: addOnKey, ...addOn });
        }
    });
    const categoryOrder = ["Most Used", "Less Common", "Needs Quote (External)"];
    let hasAnyItemAddOns = false;
    categoryOrder.forEach(categoryName => {
        if (categories[categoryName] && categories[categoryName].length > 0) {
            hasAnyItemAddOns = true;
            const accordionItemDiv = document.createElement('div');
            accordionItemDiv.classList.add('mb-2'); 
            const headerButton = document.createElement('button');
            headerButton.type = 'button';
            headerButton.classList.add('accordion-header');
            headerButton.innerHTML = `<span>${categoryName}</span><span class="icon transform transition-transform duration-200">&#x276F;</span>`;
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('accordion-content');
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'space-y-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4';
            categories[categoryName].forEach(addOnItem => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `itemAddOn_${addOnItem.key.replace(/\s|\(|\)|\"|\'/g, '_')}`;
                checkbox.value = addOnItem.key;
                checkbox.classList.add('rounded', 'text-orange-500', 'focus:ring-orange-500', 'item-specific-add-on-checkbox');
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${addOnItem.key} (${addOnItem.type === 'quote' ? 'QUOTE' : '$' + addOnItem.price + ' per ' + addOnItem.per})`;
                label.classList.add('checkbox-label');
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxContainer.appendChild(div);
            });
            contentDiv.appendChild(checkboxContainer);
            accordionItemDiv.appendChild(headerButton);
            accordionItemDiv.appendChild(contentDiv);
            itemSpecificAddOnsSection.appendChild(accordionItemDiv);
            headerButton.addEventListener('click', () => {
                const allCategoryAccordions = itemSpecificAddOnsSection.querySelectorAll('.accordion-header');
                const isCurrentlyOpen = headerButton.classList.contains('open');
                allCategoryAccordions.forEach(header => {
                    if (header !== headerButton) {
                        header.classList.remove('open');
                        const otherContent = header.nextElementSibling;
                        if (otherContent && otherContent.classList.contains('accordion-content')) {
                            otherContent.classList.remove('open');
                        }
                    }
                });
                if (isCurrentlyOpen) {
                    headerButton.classList.remove('open');
                    contentDiv.classList.remove('open');
                } else {
                    headerButton.classList.add('open');
                    contentDiv.classList.add('open');
                }
            });
        }
    });
    if (!hasAnyItemAddOns) { 
        if(mainTitle.parentNode) itemSpecificAddOnsSection.removeChild(mainTitle); 
        itemSpecificAddOnsSection.classList.add('hidden');
    } else {
        itemSpecificAddOnsSection.classList.remove('hidden');
    }
}

function populateGlobalAddOns() {
    if (!globalQuoteAddOnsSection) return;
    globalQuoteAddOnsSection.innerHTML = ''; 
    const categories = {};
    Object.keys(pricingData.addOns).forEach(addOnKey => {
        const addOn = pricingData.addOns[addOnKey];
        if (addOn.scope === "global") {
            if (!categories[addOn.category]) {
                categories[addOn.category] = [];
            }
            categories[addOn.category].push({ key: addOnKey, ...addOn });
        }
    });
    const categoryOrder = ["General Site & Finish", "Permits & Special Orders", "Modifications & Structural"]; 
    let hasAnyGlobalAddOns = false;
    const mainTitle = document.createElement('h2');
    mainTitle.className = "text-xl font-semibold text-sky-700 border-b border-slate-200 pb-2 mb-3";
    mainTitle.textContent = "3. Overall Quote Adjustments";
    let accordionContainer = document.createDocumentFragment(); 
    categoryOrder.forEach(categoryName => {
        if (categories[categoryName] && categories[categoryName].length > 0) {
            hasAnyGlobalAddOns = true;
            const accordionItemDiv = document.createElement('div');
            accordionItemDiv.classList.add('mb-2');
            const headerButton = document.createElement('button');
            headerButton.type = 'button';
            headerButton.classList.add('accordion-header');
            headerButton.innerHTML = `<span>${categoryName}</span><span class="icon transform transition-transform duration-200">&#x276F;</span>`;
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('accordion-content');
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'space-y-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4';
            categories[categoryName].forEach(addOnItem => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `globalAddOn_${addOnItem.key.replace(/\s|\(|\)|\"|\'/g, '_')}`;
                checkbox.value = addOnItem.key;
                checkbox.classList.add('rounded', 'text-orange-500', 'focus:ring-orange-500', 'global-add-on-checkbox');
                checkbox.addEventListener('change', updateFullQuoteSummaryDisplay);
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${addOnItem.key} (${addOnItem.type === 'quote' ? 'QUOTE' : '$' + addOnItem.price + ' per ' + addOnItem.per})`;
                label.classList.add('checkbox-label');
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxContainer.appendChild(div);
            });
            contentDiv.appendChild(checkboxContainer);
            accordionItemDiv.appendChild(headerButton);
            accordionItemDiv.appendChild(contentDiv);
            accordionContainer.appendChild(accordionItemDiv); 
            headerButton.addEventListener('click', () => {
                const allAccordionHeaders = globalQuoteAddOnsSection.querySelectorAll('.accordion-header');
                const isCurrentlyOpen = headerButton.classList.contains('open');
                allAccordionHeaders.forEach(header => {
                    if (header !== headerButton) {
                        header.classList.remove('open');
                        const otherContent = header.nextElementSibling;
                        if(otherContent && otherContent.classList.contains('accordion-content')){
                            otherContent.classList.remove('open');
                        }
                    }
                });
                if (isCurrentlyOpen) {
                    headerButton.classList.remove('open');
                    contentDiv.classList.remove('open');
                } else {
                    headerButton.classList.add('open');
                    contentDiv.classList.add('open');
                }
            });
        }
    });
    if (hasAnyGlobalAddOns) {
        globalQuoteAddOnsSection.appendChild(mainTitle); 
        globalQuoteAddOnsSection.appendChild(accordionContainer); 
        globalQuoteAddOnsSection.classList.remove('hidden');
    } else {
        globalQuoteAddOnsSection.classList.add('hidden');
    }
}

function handleProductTypeChange() { 
    const type = productTypeSelect.value;
    windowOptionsSection.classList.add('hidden');
    doorOptionsSection.classList.add('hidden');
    if (type) { 
        itemSpecificAddOnsSection.classList.remove('hidden');
    } else {
        itemSpecificAddOnsSection.classList.add('hidden');
    }
    resetCurrentItemDisplay(); 
    if (type === 'window') {
        windowOptionsSection.classList.remove('hidden');
        populateWindowManufacturers();
        handleWindowSizeModeChange(); 
        if(windowQuantityInput) windowQuantityInput.value = "1"; 
    } else if (type === 'door') {
        doorOptionsSection.classList.remove('hidden');
        populateDoorManufacturers();
    }
    document.querySelectorAll('.item-specific-add-on-checkbox').forEach(cb => cb.checked = false);
}
function handleWindowSizeModeChange() { 
    const selectedModeRadio = document.querySelector('input[name="windowSizeMode"]:checked');
    if (!selectedModeRadio) return; 
    const selectedMode = selectedModeRadio.value;
    if (selectedMode === 'ui') {
        windowUISizeSection.classList.remove('hidden');
        windowWHSizeSection.classList.add('hidden');
        calculatedUIDisplay.classList.add('hidden');
    } else { 
        windowUISizeSection.classList.add('hidden');
        windowWHSizeSection.classList.remove('hidden');
        calculatedUIDisplay.classList.remove('hidden');
        updateCalculatedUI();
    }
    handleWindowUIInputChange(); 
}
function updateCalculatedUI() { 
    const width = parseFloat(windowWidthInput.value) || 0;
    const height = parseFloat(windowHeightInput.value) || 0;
    const ui = width + height;
    calculatedUIValue.textContent = ui;
    handleWindowUIInputChange(); 
}
function getEffectiveUI() { 
    const selectedModeRadio = document.querySelector('input[name="windowSizeMode"]:checked');
    if (!selectedModeRadio) return parseFloat(windowUIInput.value) || 0; 
    const selectedMode = selectedModeRadio.value;
    if (selectedMode === 'wh') {
        const width = parseFloat(windowWidthInput.value) || 0;
        const height = parseFloat(windowHeightInput.value) || 0;
        return width + height;
    }
    return parseFloat(windowUIInput.value) || 0;
}
function handleWindowUIInputChange() { 
    // This function is now empty because window type is always shown for Anlin/Catalina
    // and the old UI > 130 logic is deprecated for it.
    // It can be used for other manufacturers if needed.
}
function populateSelect(selectElement, optionsArray, defaultOptionText = "-- Select --") { 
    if (!selectElement) return;
    selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
    optionsArray.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option; opt.textContent = option; selectElement.appendChild(opt);
    });
}
function populateWindowManufacturers() { 
    if (!windowManufacturerSelect || !windowSeriesSelect || !windowTypeSelect) return;
    const manufacturers = Object.keys(pricingData.windows.manufacturers);
    populateSelect(windowManufacturerSelect, manufacturers, "-- Select Manufacturer --");
    windowSeriesSelect.innerHTML = '<option value="">-- Select Series --</option>'; 
    windowTypeSelect.innerHTML = '<option value="">-- Select Type --</option>'; 
}
function populateWindowSeries() { 
    if (!windowManufacturerSelect || !windowSeriesSelect || !windowTypeSelect || !anlinColorSection || !windowSpecialNotesDiv) return;
    const manufacturer = windowManufacturerSelect.value;
    windowSeriesSelect.innerHTML = '<option value="">-- Select Series --</option>'; 
    windowTypeSelect.innerHTML = '<option value="">-- Select Type --</option>'; 
    anlinColorSection.classList.add('hidden'); 
    windowSpecialNotesDiv.classList.add('hidden'); windowSpecialNotesDiv.textContent = '';
    anlinFrameTypeSection.classList.add('hidden');
    sashDeadBoltSection.classList.add('hidden');
    if (manufacturer && pricingData.windows.manufacturers[manufacturer]) {
        const series = Object.keys(pricingData.windows.manufacturers[manufacturer].series);
        populateSelect(windowSeriesSelect, series, "-- Select Series --");
    }
}
function handleWindowTypeChange() {
    if (!windowManufacturerSelect || !windowSeriesSelect || !windowTypeSelect || !sashDeadBoltSection) return;
    const manufacturer = windowManufacturerSelect.value;
    const seriesName = windowSeriesSelect.value;
    const windowTypeValue = windowTypeSelect.value;
    sashDeadBoltSection.classList.add('hidden');
    const seriesData = pricingData.windows.manufacturers[manufacturer]?.series[seriesName];
    if (seriesData?.pricingModel === 'new') {
        const validTypesForDeadbolt = ["XO/OX Single Glider", "XOX 3-Lite Glider"];
        if (validTypesForDeadbolt.includes(windowTypeValue)) {
            sashDeadBoltSection.classList.remove('hidden');
        }
    }
}

function updateWindowOptionsForSeries() { 
    if (!windowManufacturerSelect || !windowSeriesSelect || !windowTypeSelect || !anlinColorSection || !sashDeadBoltSection || !windowSpecialNotesDiv || !anlinFrameTypeSection) return;
    const manufacturer = windowManufacturerSelect.value;
    const seriesName = windowSeriesSelect.value;
    
    // Hide all optional sections by default
    anlinColorSection.classList.add('hidden');
    windowSpecialNotesDiv.innerHTML = '';
    windowSpecialNotesDiv.classList.add('hidden'); 
    anlinFrameTypeSection.classList.add('hidden');
    windowTypeSection.classList.add('hidden');
    sashDeadBoltSection.classList.add('hidden');

    if (manufacturer && seriesName && pricingData.windows.manufacturers[manufacturer]?.series[seriesName]) {
        const seriesData = pricingData.windows.manufacturers[manufacturer].series[seriesName];

        windowTypeSection.classList.remove('hidden');
        const currentWindowType = windowTypeSelect.value;
        populateSelect(windowTypeSelect, seriesData.windowTypes, "-- Select Window Type --");
        if(currentWindowType && seriesData.windowTypes.includes(currentWindowType)){
            windowTypeSelect.value = currentWindowType;
        }

        if (seriesData.pricingModel === "new") { 
            anlinFrameTypeSection.classList.remove('hidden');
            if(anlinFrameTypeSelect.options.length <=1) { // Populate only if empty
                populateSelect(anlinFrameTypeSelect, pricingData.windows.anlinFrameTypes, "-- Select Frame Type --");
            }
            
            if(seriesData.colors) {
                anlinColorSection.classList.remove('hidden');
                 if(anlinColorSelect.options.length <=1) { // Populate only if empty
                    populateSelect(anlinColorSelect, Object.keys(seriesData.colors), "-- Select Color --");
                 }
            }
        } else { // Old model
             if(seriesData.colors?.["Black/Black"]) {
                anlinColorSection.classList.remove('hidden');
                populateSelect(anlinColorSelect, Object.keys(seriesData.colors), "-- Select Color --");
             }
        }
        
        let notesToShow = [];
        if (seriesData.specialNotes) {
            notesToShow.push(seriesData.specialNotes);
        }

        if (notesToShow.length > 0) {
            windowSpecialNotesDiv.innerHTML = notesToShow.map(note => `<span>Note: ${note}</span>`).join('<br>');
            windowSpecialNotesDiv.classList.remove('hidden');
        }
        handleWindowTypeChange(); // Check if sash deadbolt should be shown
    } else {
         windowTypeSelect.innerHTML = '<option value="">-- Select Type --</option>'; 
    }
}
function populateDoorManufacturers() { 
    if (!doorManufacturerSelect || !doorSeriesSelect || !doorHeightTypeSelect || !doorSizeSelect) return;
    const manufacturers = Object.keys(pricingData.doors.manufacturers);
    populateSelect(doorManufacturerSelect, manufacturers, "-- Select Manufacturer --");
    doorSeriesSelect.innerHTML = '<option value="">-- Select Series --</option>';
    doorHeightTypeSelect.value = "";
    doorSizeSelect.innerHTML = '<option value="">-- Select Size --</option>';
}
function populateDoorSeries() { 
    if (!doorManufacturerSelect || !doorSeriesSelect || !doorHeightTypeSelect || !doorSizeSelect) return;
    const manufacturer = doorManufacturerSelect.value;
    doorSeriesSelect.innerHTML = '<option value="">-- Select Series --</option>';
    doorHeightTypeSelect.value = ""; doorSizeSelect.innerHTML = '<option value="">-- Select Size --</option>'; 
    if (manufacturer && pricingData.doors.manufacturers[manufacturer]) {
        const series = Object.keys(pricingData.doors.manufacturers[manufacturer].series);
        populateSelect(doorSeriesSelect, series, "-- Select Series --");
    }
}
function populateDoorSizes() { 
    if (!doorManufacturerSelect || !doorSeriesSelect || !doorHeightTypeSelect || !doorSizeSelect) return;
    const manufacturer = doorManufacturerSelect.value;
    const series = doorSeriesSelect.value;
    const heightType = doorHeightTypeSelect.value;
    doorSizeSelect.innerHTML = '<option value="">-- Select Size --</option>'; 
    if (manufacturer && series && heightType && pricingData.doors.manufacturers[manufacturer]?.series[series]?.prices[heightType]) {
        const sizes = Object.keys(pricingData.doors.manufacturers[manufacturer].series[series].prices[heightType]);
        populateSelect(doorSizeSelect, sizes, "-- Select Size --");
    }
}

function resetCurrentItemDisplay(message = "Configure an item above and calculate its price.") { 
    if (currentItemPriceDisplay) currentItemPriceDisplay.textContent = "$0.00";
    if (currentItemDescriptionDisplay) currentItemDescriptionDisplay.innerHTML = message;
    if (windowQuantityInput) windowQuantityInput.value = "1"; 
    document.querySelectorAll('.item-specific-add-on-checkbox').forEach(cb => cb.checked = false);
    if(editingItemIndex === null && productTypeSelect) {
        // Only fully reset if not in edit mode
        if(windowUIInput) windowUIInput.value = "";
        if(windowWidthInput) windowWidthInput.value = "";
        if(windowHeightInput) windowHeightInput.value = "";
        if(windowGridsCheckbox) windowGridsCheckbox.checked = false;
        if(windowTemperedCheckbox) windowTemperedCheckbox.checked = false;
        if(windowObscureCheckbox) windowObscureCheckbox.checked = false;
        if(windowTypeSelect) windowTypeSelect.value = "";
        if(anlinColorSelect) anlinColorSelect.value = "";
        if(sashDeadBoltCheckbox) sashDeadBoltCheckbox.checked = false;
    }
}

function calculateAndShowSummary() {
    const calculatedItem = calculateCurrentItemPriceFunction();
    if (calculatedItem) {
        currentItemPriceDisplay.textContent = formatCurrency(calculatedItem.price);
        
        let descriptionHtml = `<p class="font-bold text-slate-800">Number of Units: ${calculatedItem.details.quantity}</p>`;
        descriptionHtml += `<p class="font-semibold mt-1">${calculatedItem.description}</p>`;
        
        const optionsList = [];
        const allAddOns = [...calculatedItem.details.adders, ...calculatedItem.details.itemAddOns];
        if (allAddOns.length > 0) {
            allAddOns.forEach(addOn => {
                optionsList.push(`<li>${addOn.key} <span class="text-slate-500">${addOn.displayValue || ''}</span></li>`);
            });
            descriptionHtml += `<ul class="list-disc list-inside ml-4 mt-1">${optionsList.join('')}</ul>`;
        }
        if (calculatedItem.itemNotes) {
            descriptionHtml += `<p class="text-xs text-red-600 mt-1">${calculatedItem.itemNotes}</p>`;
        }
        if (calculatedItem.requiresManualQuote) {
            descriptionHtml += ` <p class="font-semibold text-orange-500 mt-1">- REQUIRES MANUAL QUOTE</p>`;
        }
        currentItemDescriptionDisplay.innerHTML = descriptionHtml;
    }
}

function getAnlinBracketPrice(ui, windowType, frameType, pricingTable) {
    const typePricing = pricingTable[windowType]?.[frameType];
    if (!typePricing) return null;

    const brackets = Object.keys(typePricing).map(b => {
        const parts = b.split('-').map(Number);
        return { min: parts[0], max: parts[1], price: typePricing[b] };
    });

    for (const bracket of brackets) {
        if (ui >= bracket.min && ui <= bracket.max) {
            return bracket.price;
        }
    }
    
    return null; // UI is outside all defined brackets
}


function calculateCurrentItemPriceFunction() { 
    let singleItemPrice = 0;
    let basePrice = 0;
    let baseDescription = ""; 
    let requiresManualQuoteItem = false;
    let itemDetails = { 
        type: productTypeSelect.value, 
        itemAddOns: [], 
        adders: []      
    }; 
    let itemNotes = ""; 
    if(windowSpecialNotesDiv) {
        windowSpecialNotesDiv.innerHTML = '';
        windowSpecialNotesDiv.classList.add('hidden');
    }
    const selectedProductType = productTypeSelect.value;
    if (!selectedProductType) {
        showToast("Please select a product type first.", "error");
        return null;
    }
    if (selectedProductType === 'window') {
        const quantity = parseInt(windowQuantityInput.value) || 1;
        itemDetails.quantity = quantity;
        const manufacturer = windowManufacturerSelect.value;
        const seriesName = windowSeriesSelect.value;
        const windowTypeValue = windowTypeSelect.value;
        const anlinFrameTypeValue = anlinFrameTypeSelect.value;
        const anlinColorValue = anlinColorSelect.value;
        const ui = getEffectiveUI(); 

        itemDetails.sizingMode = document.querySelector('input[name="windowSizeMode"]:checked').value;
        if (itemDetails.sizingMode === 'wh') {
            itemDetails.width = parseFloat(windowWidthInput.value) || 0;
            itemDetails.height = parseFloat(windowHeightInput.value) || 0;
        } else {
            itemDetails.uiValue = ui; 
        }
        itemDetails.manufacturer = manufacturer;
        itemDetails.series = seriesName;
        itemDetails.ui = ui; 
        itemDetails.windowType = windowTypeValue;
        itemDetails.anlinFrameType = anlinFrameTypeValue;
        itemDetails.anlinColor = anlinColorValue;
        baseDescription = `Window: ${manufacturer} ${seriesName}, UI: ${ui}, Type: ${windowTypeValue}`;
        if(manufacturer === "ANLIN" && seriesName === "CATALINA") {
            baseDescription += `, Frame: ${anlinFrameTypeValue}, Color: ${anlinColorValue}`;
        }
        
        if (!manufacturer || !seriesName) { showToast("Please select window manufacturer and series.", "error"); return null; }
        if (!windowTypeValue) { showToast("Please select a window type.", "error"); return null; }
        if (ui <= 0) { showToast("Please enter/calculate a valid UI for the window.", "error"); return null; }

        const seriesData = pricingData.windows.manufacturers[manufacturer]?.series[seriesName];
        if (!seriesData) { showToast("Pricing data not found for selected window series.", "error"); return null; }

        if (seriesData.pricingModel === 'new') {
            if (!anlinFrameTypeValue) { showToast("Please select a frame type for Anlin windows.", "error"); return null; }
            if (!anlinColorValue) { showToast("Please select a color for Anlin windows.", "error"); return null; }
            const bracketPrice = getAnlinBracketPrice(ui, windowTypeValue, anlinFrameTypeValue, seriesData.pricingTable);
            if (bracketPrice === null) {
                requiresManualQuoteItem = true;
                itemNotes += ` (UI of ${ui} is outside the pricing range for this window type)`;
                singleItemPrice = 0;
            } else {
                singleItemPrice = bracketPrice;
            }
        } else { // Old model
            if (ui <= 65) singleItemPrice = seriesData.basePrice.upTo65UI;
            else if (ui <= 130) singleItemPrice = seriesData.basePrice.upTo130UI;
            else {
                singleItemPrice = seriesData.basePrice.upTo130UI;
                const uiFactor = seriesData.uiFactorOver130[windowTypeValue];
                if (uiFactor !== null && uiFactor !== undefined) singleItemPrice += (ui - 130) * uiFactor;
                else itemNotes += ` (Note: No UI factor for ${windowTypeValue} > 130 UI)`;
            }
        }
        
        basePrice = singleItemPrice;
        itemDetails.adders.push({key: "Base Unit Price", displayValue: `(${formatCurrency(basePrice)})`});
        
        if (seriesData.colors && anlinColorValue && seriesData.colors[anlinColorValue]) {
            const multiplierValue = seriesData.colors[anlinColorValue];
            if (multiplierValue !== 1.0) {
                const colorUpcharge = (basePrice * multiplierValue) - basePrice;
                singleItemPrice += colorUpcharge;
                itemDetails.adders.push({key: `${anlinColorValue} Color Finish`, displayValue: `(+${formatCurrency(colorUpcharge)})`});
            }
        }

        if (windowGridsCheckbox.checked) { 
            const cost = seriesData.addersUiFactor.GRIDS * ui;
            singleItemPrice += cost; 
            itemDetails.adders.push({key: "Grids", displayValue: `(+${formatCurrency(cost)})`});
        }
        if (windowTemperedCheckbox.checked) { 
            const cost = seriesData.addersUiFactor.TEMPERED * ui;
            singleItemPrice += cost; 
            itemDetails.adders.push({key: "Tempered", displayValue: `(+${formatCurrency(cost)})`});
        }
        if (windowObscureCheckbox.checked) { 
            const cost = seriesData.addersUiFactor.OBSCURE * ui;
            singleItemPrice += cost; 
            itemDetails.adders.push({key: "Obscure", displayValue: `(+${formatCurrency(cost)})`});
        }
        if (sashDeadBoltCheckbox.checked && !sashDeadBoltSection.classList.contains('hidden')) {
            const cost = seriesData.adders["Sash Dead-Bolt"];
            singleItemPrice += cost;
            itemDetails.adders.push({key: "Sash Dead-Bolt", displayValue: `(+${formatCurrency(cost)})`});
        }

        if (seriesData.specialNotes) {
             if (windowSpecialNotesDiv) {
                let currentNotesHTML = windowSpecialNotesDiv.innerHTML;
                let seriesNoteHTML = `<span>Note: ${seriesData.specialNotes}</span>`;
                windowSpecialNotesDiv.innerHTML = currentNotesHTML ? `${currentNotesHTML}<br>${seriesNoteHTML}` : seriesNoteHTML;
                windowSpecialNotesDiv.classList.remove('hidden');
            }
        }
        
    } else if (selectedProductType === 'door') { 
        itemDetails.quantity = 1; 
        const manufacturer = doorManufacturerSelect.value;
        const seriesName = doorSeriesSelect.value;
        const heightType = doorHeightTypeSelect.value;
        const size = doorSizeSelect.value;
        itemDetails.manufacturer = manufacturer; itemDetails.series = seriesName;
        itemDetails.heightType = heightType; itemDetails.size = size;
        baseDescription = `Door: ${manufacturer} ${seriesName}, ${heightType}, ${size}`;
        if (!manufacturer || !seriesName || !heightType || !size) { 
            showToast("Please select all door options.", "error");
            return null; 
        }
        const seriesData = pricingData.doors.manufacturers[manufacturer]?.series[seriesName];
        if (!seriesData?.prices[heightType] || seriesData.prices[heightType][size] === undefined) { 
            showToast("Pricing data not found for selected door config.", "error");
            return null; 
        }
        const doorBasePrice = seriesData.prices[heightType][size];
        if (doorBasePrice === null) {
            showToast(`Selected door size (${size}) N/A for ${manufacturer} ${seriesName}.`, "error");
            requiresManualQuoteItem = true; 
            itemDetails.requiresManualQuote = true;
            singleItemPrice = 0; 
        } else {
            singleItemPrice += doorBasePrice;
            basePrice = doorBasePrice;
            itemDetails.adders.push({key: "Base Unit Price", displayValue: `(${formatCurrency(basePrice)})`});
            if (doorGridsCheckbox.checked && seriesData.adders.GRIDS_UI_FACTOR) {
                try {
                    const parts = size.match(/(\d+)'(?:-(\d+)")?x(\d+)'(?:-(\d+)")?/);
                    if (!parts) throw new Error("Could not parse door size format.");
                    const doorUI = (parseFloat(parts[1])*12 + parseFloat(parts[2]||0)) + (parseFloat(parts[3])*12 + parseFloat(parts[4]||0));
                    const cost = doorUI * seriesData.adders.GRIDS_UI_FACTOR;
                    singleItemPrice += cost;
                    itemDetails.adders.push({key: "Grids", displayValue: `(+${formatCurrency(cost)})`});
                } catch (e) { console.error("Door size parse error for grids:", e); itemNotes += " (Error calculating door grid price)";}
            }
        }
    }
    
    document.querySelectorAll('.item-specific-add-on-checkbox:checked').forEach(checkbox => {
        const addOnKey = checkbox.value;
        const addOnData = pricingData.addOns[addOnKey];
        if (addOnData) {
            let addOnPrice = 0;
            if (addOnData.type === 'fixed') {
                addOnPrice = addOnData.price;
                singleItemPrice += addOnPrice;
            } else if (addOnData.type === 'quote') {
                requiresManualQuoteItem = true;
            }
            itemDetails.itemAddOns.push({ 
                key: addOnKey, 
                displayValue: `(${addOnData.type === 'quote' ? 'QUOTE' : `+${formatCurrency(addOnPrice)}`})`,
                price: addOnPrice,
                requiresManualQuote: addOnData.type === 'quote'
            });
        }
    });

    itemDetails.unitPrice = singleItemPrice;
    const totalPrice = singleItemPrice * (itemDetails.quantity || 1);

    return {
        price: totalPrice,
        description: baseDescription,
        requiresManualQuote: requiresManualQuoteItem,
        details: itemDetails,
        itemNotes: itemNotes
    };
}

function addItemOrUpdateQuote() { 
    const calculatedItem = calculateCurrentItemPriceFunction();
    if (!calculatedItem) {
        showToast("Please complete all required fields before adding.", "error");
        return;
    }
    
    const newItem = {
        baseDescription: calculatedItem.description, 
        price: calculatedItem.price,
        requiresManualQuote: calculatedItem.requiresManualQuote,
        details: calculatedItem.details,
    };
    if (editingItemIndex !== null) {
        quoteItems.splice(editingItemIndex, 1, newItem); 
        showToast("Item updated ✅", "success");
    } else {
        quoteItems.push(newItem);
        showToast("Item added ✅", "success");
    }
    isSettingUpEdit = false; 
    updateFullQuoteSummaryDisplay();
    resetCurrentItemDisplay("Item added. Configure next item or finalize quote.");
}
function startEditItem(index) { 
    isSettingUpEdit = true; 
    const itemToEdit = quoteItems[index];
    if (!itemToEdit) {
        isSettingUpEdit = false; 
        return;
    }
    productTypeSelect.value = itemToEdit.details.type;
    handleProductTypeChange(); 
    editingItemIndex = index; 
    if (addItemToQuoteBtn) addItemToQuoteBtn.textContent = "Update This Item in Quote";
    setTimeout(() => { 
        if (itemToEdit.details.type === 'window') {
            windowManufacturerSelect.value = itemToEdit.details.manufacturer;
            populateWindowSeries(); 
            setTimeout(() => { 
                windowSeriesSelect.value = itemToEdit.details.series;
                updateWindowOptionsForSeries(); 
                if (itemToEdit.details.anlinFrameType) {
                    anlinFrameTypeSelect.value = itemToEdit.details.anlinFrameType;
                }
                 if (itemToEdit.details.anlinColor) {
                    anlinColorSelect.value = itemToEdit.details.anlinColor;
                }
                if(itemToEdit.details.windowType) windowTypeSelect.value = itemToEdit.details.windowType;
                windowQuantityInput.value = itemToEdit.details.quantity || 1; 
                const sizingMode = itemToEdit.details.sizingMode || 'ui'; 
                document.querySelector(`input[name="windowSizeMode"][value="${sizingMode}"]`).checked = true;
                handleWindowSizeModeChange(); 
                if (sizingMode === 'wh') {
                    windowWidthInput.value = itemToEdit.details.width || '';
                    windowHeightInput.value = itemToEdit.details.height || '';
                    updateCalculatedUI();
                } else {
                    windowUIInput.value = itemToEdit.details.uiValue || itemToEdit.details.ui || ''; 
                }
                windowGridsCheckbox.checked = itemToEdit.details.adders?.some(a => a.key === "Grids") || false;
                windowTemperedCheckbox.checked = itemToEdit.details.adders?.some(a => a.key === "Tempered") || false;
                windowObscureCheckbox.checked = itemToEdit.details.adders?.some(a => a.key === "Obscure") || false;
                sashDeadBoltCheckbox.checked = itemToEdit.details.adders?.some(a => a.key === "Sash Dead-Bolt") || false;
            }, 50); 
        } else if (itemToEdit.details.type === 'door') {
            doorManufacturerSelect.value = itemToEdit.details.manufacturer;
            populateDoorSeries();
            setTimeout(() => { 
                doorSeriesSelect.value = itemToEdit.details.series;
                doorHeightTypeSelect.value = itemToEdit.details.heightType;
                populateDoorSizes();
                setTimeout(() => { 
                     doorSizeSelect.value = itemToEdit.details.size;
                }, 50);
                doorGridsCheckbox.checked = itemToEdit.details.adders?.some(a => a.key === "Grids") || false;
            }, 50); 
        }
        document.querySelectorAll('.item-specific-add-on-checkbox').forEach(cb => cb.checked = false); 
        if (itemToEdit.details.itemAddOns && Array.isArray(itemToEdit.details.itemAddOns)) {
            itemToEdit.details.itemAddOns.forEach(appliedAddOn => {
                const checkboxId = `itemAddOn_${appliedAddOn.key.replace(/\s|\(|\)|\"|\'/g, '_')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) checkbox.checked = true;
            });
        }
        calculateAndShowSummary(); 
        if (addItemToQuoteBtn) addItemToQuoteBtn.textContent = "Update This Item in Quote"; 
        if(pricingForm) pricingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        isSettingUpEdit = false; 
    }, 200); 
}
function removeItemFromQuote(index) {
    if (index < 0 || index >= quoteItems.length) return;
    const itemDescription = quoteItems[index].baseDescription.substring(0, 50);
    showConfirmationModal(`Are you sure you want to remove item ${index + 1}: "${itemDescription}..."?`, () => {
        quoteItems.splice(index, 1); 
        if (editingItemIndex === index) { 
            isSettingUpEdit = false; 
            resetCurrentItemDisplay("Previously editing item removed. Configure new item.");
        } else if (editingItemIndex !== null && index < editingItemIndex) {
            editingItemIndex--; 
        }
        updateFullQuoteSummaryDisplay();
        showToast("Item removed.", "info");
    });
}

function showConfirmationModal(message, onConfirm) {
    const existingModal = document.getElementById('confirmationModal');
    if (existingModal) { existingModal.remove(); }
    const modalOverlay = document.createElement('div');
    modalOverlay.id = 'confirmationModal';
    modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    const modalContent = document.createElement('div');
    modalContent.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full';
    const messageP = document.createElement('p');
    messageP.className = 'text-slate-700 text-base mb-4';
    messageP.textContent = message;
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex justify-end gap-3';
    const confirmButton = document.createElement('button');
    confirmButton.className = 'btn w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-red-500 text-base font-medium rounded-md shadow-sm text-red-600 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500'; 
    confirmButton.textContent = 'Confirm';
    confirmButton.onclick = () => {
        onConfirm();
        modalOverlay.remove();
    };
    const cancelButton = document.createElement('button');
    cancelButton.className = 'btn w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-slate-700 bg-slate-200 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500'; 
    cancelButton.textContent = 'Cancel';
    cancelButton.onclick = () => {
        modalOverlay.remove();
    };
    buttonContainer.appendChild(cancelButton);
    buttonContainer.appendChild(confirmButton);
    modalContent.appendChild(messageP);
    modalContent.appendChild(buttonContainer);
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
}

function formatCurrency(number) {
    return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
}

function updateFullQuoteSummaryDisplay() {
    if (!quoteItemsListDisplay || !grandTotalPriceSpan || !manualQuoteItemsList || !manualQuoteItemsSection || !emptyQuoteMsg || !quoteTotalsBreakdown) return;
    quoteItemsListDisplay.innerHTML = ''; 
    let itemsSubtotal = 0;
    let collectiveManualQuoteMessages = [];
    if (quoteItems.length === 0) {
        if(emptyQuoteMsg) emptyQuoteMsg.style.display = 'block'; 
    } else {
        if(emptyQuoteMsg) emptyQuoteMsg.style.display = 'none'; 
        quoteItems.forEach((item, index) => {
            const itemCard = document.createElement('div');
            itemCard.classList.add('quote-item-card');
            
            const mainContentDiv = document.createElement('div');
            mainContentDiv.classList.add('flex', 'justify-between', 'items-start');

            const descriptionDiv = document.createElement('div');
            descriptionDiv.classList.add('flex-grow');

            const baseDescP = document.createElement('p');
            baseDescP.classList.add('font-semibold');
            baseDescP.innerHTML = `${index + 1}. <span class="text-red-600 font-bold">${item.details.quantity}</span> x ${item.baseDescription}`;

            let descriptionHtml = '';
            const optionsList = [];
            const allAddOns = [...(item.details.adders || []), ...(item.details.itemAddOns || [])];
            if (allAddOns.length > 0) {
                allAddOns.forEach(addOn => {
                    optionsList.push(`<li>${addOn.key} <span class="option-cost-detail">${addOn.displayValue || ''}</span></li>`);
                });
            }
            if (optionsList.length > 0) {
                descriptionHtml += `<ul class="list-disc list-inside ml-4 mt-1 text-xs text-slate-500">${optionsList.join('')}</ul>`;
            }
             if (item.requiresManualQuote) {
                descriptionHtml += ` <span class="font-semibold text-orange-500">- MANUAL QUOTE</span>`;
            }
            
            descriptionDiv.appendChild(baseDescP);
            descriptionDiv.innerHTML += descriptionHtml;

            // --- Actions and Price ---
            const rightSideDiv = document.createElement('div');
            rightSideDiv.classList.add('text-right', 'flex-shrink-0', 'ml-4');
            
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('quote-item-actions', 'no-print', 'justify-end', 'mb-1');

            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'px-2 py-1 text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 focus:ring-sky-500 rounded-l-md shadow-sm';
            editButton.onclick = () => startEditItem(index);

            const copyButton = document.createElement('button');
            copyButton.textContent = 'Copy';
            copyButton.className = 'px-2 py-1 text-xs font-medium text-white bg-slate-500 hover:bg-slate-600 focus:ring-slate-400 shadow-sm ml-px'; 
            copyButton.onclick = () => copyItemFromQuote(index);

            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.className = 'px-2 py-1 text-xs font-medium text-white bg-red-600 hover:bg-red-700 focus:ring-red-500 rounded-r-md shadow-sm ml-px';
            removeButton.onclick = () => removeItemFromQuote(index);
            
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(copyButton);
            actionsDiv.appendChild(removeButton);

            const priceP = document.createElement('p');
            priceP.classList.add('quote-item-price', 'text-base');
            priceP.innerHTML = item.requiresManualQuote ? "Manual Quote" : `<span class="item-line-price">${formatCurrency(item.price)}</span>`;

            rightSideDiv.appendChild(actionsDiv);
            rightSideDiv.appendChild(priceP);
            
            mainContentDiv.appendChild(descriptionDiv);
            mainContentDiv.appendChild(rightSideDiv);
            
            itemCard.appendChild(mainContentDiv);
            quoteItemsListDisplay.appendChild(itemCard);
            
            if (!item.requiresManualQuote) { 
                 itemsSubtotal += item.price;
            }
            if (item.requiresManualQuote) {
                 let baseItemDescOnly = item.baseDescription.split(', Type:')[0]; 
                 collectiveManualQuoteMessages.push(`${index + 1}. ${baseItemDescOnly} (or one of its add-ons)`);
            }
        });
    }
    let globalAddOnsTotal = 0;
    let globalAddOnsDescriptions = [];
    document.querySelectorAll('.global-add-on-checkbox:checked').forEach(checkbox => {
        const addOnKey = checkbox.value;
        const addOnData = pricingData.addOns[addOnKey];
        if (addOnData) {
            globalAddOnsDescriptions.push({
                key: addOnKey,
                description: `${addOnKey} (${addOnData.type === 'quote' ? 'QUOTE' : '$' + addOnData.price + ' per ' + addOnData.per})`,
                price: addOnData.type === 'fixed' ? addOnData.price : 0,
                requiresManualQuote: addOnData.type === 'quote'
            });
            if (addOnData.type === 'fixed') {
                globalAddOnsTotal += addOnData.price;
            } else if (addOnData.type === 'quote') {
                collectiveManualQuoteMessages.push(`${addOnKey} (Overall Quote Adjustment)`);
            }
        }
    });
    quoteTotalsBreakdown.innerHTML = ''; 
    if (quoteItems.length > 0 || globalAddOnsDescriptions.length > 0) { 
         const subtotalDiv = document.createElement('div');
         subtotalDiv.classList.add('summary-item');
         subtotalDiv.innerHTML = `<span class="summary-label">Items Subtotal:</span><span class="summary-value">${formatCurrency(itemsSubtotal)}</span>`;
         quoteTotalsBreakdown.appendChild(subtotalDiv);
    }
    if (globalAddOnsDescriptions.length > 0) {
        const addOnsTitleDiv = document.createElement('div');
        addOnsTitleDiv.classList.add('summary-label', 'mt-2', 'font-medium');
        addOnsTitleDiv.textContent = 'Overall Quote Adjustments:';
        quoteTotalsBreakdown.appendChild(addOnsTitleDiv);
        globalAddOnsDescriptions.forEach(addOn => {
            const addOnDiv = document.createElement('div');
            addOnDiv.classList.add('summary-item', 'ml-2', 'text-sm');
            addOnDiv.innerHTML = `<span class="summary-label">${addOn.key}:</span><span class="summary-value">${addOn.requiresManualQuote ? 'Manual Quote' : formatCurrency(addOn.price)}</span>`;
            quoteTotalsBreakdown.appendChild(addOnDiv);
        });
    }
    const grandTotal = itemsSubtotal + globalAddOnsTotal;
    grandTotalPriceSpan.textContent = formatCurrency(grandTotal);
    manualQuoteItemsList.innerHTML = '';
    if (collectiveManualQuoteMessages.length > 0) {
        const uniqueMessages = [...new Set(collectiveManualQuoteMessages)];
        uniqueMessages.forEach(msg => {
            const li = document.createElement('li');
            li.textContent = msg;
            manualQuoteItemsList.appendChild(li);
        });
        manualQuoteItemsSection.classList.remove('hidden');
    } else {
        manualQuoteItemsSection.classList.add('hidden');
    }
}

function copyItemFromQuote(index) {
    if (index < 0 || index >= quoteItems.length) return;
    const itemToCopy = quoteItems[index];
    const copiedItem = JSON.parse(JSON.stringify(itemToCopy)); 
    quoteItems.push(copiedItem); 
    updateFullQuoteSummaryDisplay();
    showToast("Item copied successfully! ✅", "success");
}

function clearQuote() { 
    if (quoteItems.length === 0) {
        showToast("Quote is already empty.", "info");
        return;
    }
    showConfirmationModal("Are you sure you want to clear the entire quote? This action cannot be undone.", () => {
        isSettingUpEdit = false; 
        quoteItems = [];
        document.querySelectorAll('.item-specific-add-on-checkbox').forEach(cb => cb.checked = false);
        document.querySelectorAll('.global-add-on-checkbox').forEach(cb => cb.checked = false);
        resetCurrentItemDisplay("Quote cleared. Configure an item.");
        updateFullQuoteSummaryDisplay();
        showToast("Quote cleared successfully.", "success");
    });
}

function handlePrintQuote() { 
    if(printDateSpan) printDateSpan.textContent = new Date().toLocaleDateString();
    document.body.classList.remove('print-no-pricing-mode');
    window.print();
}

function handlePrintQuoteNoPricing() {
    if(printDateSpan) printDateSpan.textContent = new Date().toLocaleDateString();
    document.body.classList.add('print-no-pricing-mode');
    window.print();
}

window.addEventListener('beforeunload', function (e) {
    if (quoteItems.length > 0) {
        const confirmationMessage = 'You have unsaved items in your quote. Are you sure you want to leave? Changes will be lost.';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});
</script>


</body></html>
